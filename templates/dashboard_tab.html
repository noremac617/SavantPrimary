{% macro colorize(val) -%}
  <span class="{% if val > 0 %}text-success{% elif val < 0 %}text-danger{% else %}text-muted{% endif %}">
    {{ val }}%
  </span>
{%- endmacro %}

<style>
  .card {
    background-color: #0f0f0f;
    border: 1px solid #2c2c2c;
    border-radius: 0.75rem;
    box-shadow: 0 0 15px rgba(0, 184, 255, 0.2);
  }

  .card-header {
    background-color: #2a2a2a;
    color: #00b8ff !important;
    font-weight: bold;
  }

  .text-light,
  .card-body label,
  .form-label,
  .form-control,
  .form-select,
  .form-range,
  .card-body,
  .card-body strong {
    color: #e0e0e0 !important;
  }

  .form-range::-webkit-slider-thumb {
    background-color: #00b8ff;
  }

  /* Primary buttons - black with blue border and full blue on hover */
  .btn,
  .btn-sm {
    background-color: #000 !important;
    color: #00b8ff !important;
    border: 1px solid #00b8ff !important;
    font-weight: 600;
  }

  .btn:hover,
  .btn:active,
  .btn:focus {
    background-color: #00b8ff !important;
    color: #000 !important;
    box-shadow: none !important;
  }

  /* Override Bootstrap colors for semantic buttons */
  .btn-success,
  .btn-danger,
  .btn-warning,
  .btn-info {
    background-color: #000 !important;
    color: #00b8ff !important;
    border: 1px solid #00b8ff !important;
  }

  .btn-success:hover,
  .btn-danger:hover,
  .btn-warning:hover,
  .btn-info:hover {
    background-color: #00b8ff !important;
    color: #000 !important;
  }

  .badge.bg-success,
  .badge.bg-danger {
    font-size: 1rem;
    padding: 0.5rem 1rem;
  }

  #recent-logs-box {
    background-color: #0f0f0f;
    font-family: monospace;
    font-size: 0.85rem;
    line-height: 1.4;
    padding: 0.75rem 1rem;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #2c2c2c;
    border-top: none;
    border-radius: 0 0 0.75rem 0.75rem;
  }

  #recent-logs-box div {
    margin-bottom: 2px;
    white-space: pre-wrap;
  }

  .table-dark {
    background-color: #121212;
  }

  .stat-box {
    background-color: #0f0f0f;
    border: 1px solid #2c2c2c;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    color: #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1rem;
  }

  /* Alert styling for refresh status */
  .alert {
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }
</style>

<!-- Re-Authentication Alert -->
{% if token_status.get('refresh_warning') or token_status.get('refresh_expires_in_days', 8) <= 2 %}
<div class="alert alert-{{ 'danger' if token_status.get('refresh_expires_in_days', 8) <= 1 else 'warning' }} alert-dismissible fade show mb-4" role="alert">
  <div class="d-flex align-items-center">
    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
    <div class="flex-grow-1">
      <h5 class="alert-heading mb-1">
        {% if token_status.get('refresh_expires_in_days', 8) <= 1 %}
        üî¥ URGENT: Re-Authentication Required Soon!
        {% else %}
        ‚ö†Ô∏è Re-Authentication Needed Soon
        {% endif %}
      </h5>
      <p class="mb-2">
        Your Schwab API tokens will expire in <strong>{{ token_status.refresh_expires_in_days|round(1) }} days</strong>. 
        Schwab requires manual re-authentication every 7 days.
      </p>
      <p class="mb-0 small">
        <strong>What happens:</strong> The trading bot will stop working when tokens expire. Re-authenticate now to prevent interruption.
      </p>
    </div>
    <div class="ms-3">
      <a href="{{ url_for('authorize') }}" class="btn btn-{{ 'danger' if token_status.get('refresh_expires_in_days', 8) <= 1 else 'warning' }} btn-lg">
        <i class="fas fa-key"></i> Re-Authenticate Now
      </a>
    </div>
  </div>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Demo Mode Alert Banner -->
{% if demo_mode %}
<div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
  <div class="d-flex align-items-center">
    <i class="fas fa-flask fa-2x me-3"></i>
    <div class="flex-grow-1">
      <h5 class="alert-heading mb-1">üß™ Demo Mode Active</h5>
      <p class="mb-1">
        All trades are <strong>simulated</strong> with realistic market conditions. No real money is being traded.
      </p>
      <p class="mb-0 small">
        <strong>Features:</strong> Realistic slippage, bid-ask spreads, volume impact, and order delays. Data is logged for optimizer analysis.
      </p>
    </div>
    <div class="ms-3">
      <form action="/toggle_demo_mode" method="POST" class="d-inline">
        <button type="submit" class="btn btn-success btn-lg">
          <i class="fas fa-chart-line"></i> Switch to Live Trading
        </button>
      </form>
    </div>
  </div>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Today's Trades -->
<div class="card mb-4">
  <div class="card-header text-white d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
    <span>Today's Trades</span>
    <div class="d-flex align-items-center gap-3 mt-2 mt-sm-0">
      <button id="refresh-pl-btn" type="button" class="btn btn-sm btn-warning py-0 px-3">üîÑ Refresh P/L
        <span id="refresh-pl-spin" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
      </button>
      <small style="color: #00b8ff;">
        Last Refreshed: <span id="last-refresh" data-time="{{ last_refresh }}"></span>
      </small>
    </div>
  </div>
  <div class="card-body">
    {% if todays_trades %}
      <div class="table-responsive">
        <table class="table table-dark table-hover table-sm table-bordered">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Type</th>
              <th>Entry</th>
              <th>Current</th>
              <th>Status</th>
              <th>P/L</th>
            </tr>
          </thead>
          <tbody>
            {% for trade in todays_trades %}
            <tr>
              <td>{{ trade.symbol }}</td>
              <td>{{ trade.action }}</td>
              <td>{{ trade.entry }}</td>
              <td>{{ trade.current }}</td>
              <td>{{ trade.status }}</td>
              <td class="{% if trade.pl >= 0 %}text-success{% else %}text-danger{% endif %}">
                {% if trade.status in ["Hit Take Profit", "Hit Stop Loss"] %}
                  <em>{{ trade.pl | round(2) }}% (sim)</em>
                {% else %}
                  {{ trade.pl | round(2) }}%
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-light">No trades placed today.</p>
    {% endif %}
  </div>
</div>

<!-- Trade Plan and Performance Row -->
<div class="row gy-4 mb-4">
  <!-- Today's Trade Plan -->
  <div class="col-12 col-md-7">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Today's Trade Plan</span>
        <button id="refresh-sheet-btn" class="btn btn-sm btn-outline-primary" onclick="refreshSheet()">
          <i class="fas fa-sync-alt"></i> Refresh Plan
        </button>
      </div>
      <div class="card-body">
        {% if plan.buy or plan.short %}
          <div class="d-flex flex-wrap gap-3 mb-3">
            <div id="buy-tickers">
              {% for ticker in plan.buy %}
                <span class="badge bg-success fs-5 px-3 py-2 rounded-pill">{{ ticker }}</span>
              {% endfor %}
            </div>
            <div id="short-tickers">
              {% for ticker in plan.short %}
                <span class="badge bg-danger fs-5 px-3 py-2 rounded-pill">{{ ticker }}</span>
              {% endfor %}
            </div>
          </div>
          <div class="text-accent small mb-3">Last cached: <span id="last-cached">{{ last_cached }}</span></div>
        {% else %}
          <div class="text-accent small mb-3">Last cached: <span id="last-cached">{{ last_cached }}</span></div>
        {% endif %}

        <form action="/update_allocation" method="POST" class="mt-3">
          <label class="form-label fw-semibold text-light">Allocation per stock</label>
          <div class="input-group" style="max-width: 320px;">
            <input type="number"
                  name="allocation"
                  min="1"
                  max="100"
                  step="1"
                  value="{{ (allocation * 100) | round(0) }}"
                  class="form-control bg-dark text-light border-secondary text-center">
            <span class="input-group-text bg-dark text-light border-secondary">%</span>
            <button class="btn btn-sm btn-outline-primary" type="submit">Update</button>
          </div>
        </form>

        <!-- Demo Mode Toggle -->
        <div class="mt-3">
          <label class="form-label fw-semibold text-light">Trading Mode</label>
          <div class="d-flex align-items-center gap-3">
            <form action="/toggle_demo_mode" method="POST" class="d-inline">
              <button type="submit" class="btn btn-sm {{ 'btn-warning' if demo_mode else 'btn-success' }}" 
                      style="min-width: 120px;">
                {% if demo_mode %}
                  <i class="fas fa-flask"></i> Demo Mode
                {% else %}
                  <i class="fas fa-chart-line"></i> Live Trading
                {% endif %}
              </button>
            </form>
            <small class="text-light">
              {% if demo_mode %}
                <span class="text-warning">‚ö†Ô∏è Simulated trades only</span>
              {% else %}
                <span class="text-success">‚úÖ Real money trading</span>
              {% endif %}
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Stats -->
  <div class="col-12 col-md-5">
    <div class="card h-100">
      <div class="card-header">Performance</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-6">
            <div class="stat-box">
              <strong>Today:</strong>
              {{ colorize(today_pl or 0.0) }}
            </div>
          </div>
          <div class="col-6">
            <div class="stat-box">
              <strong>This Week:</strong>
              {{ colorize(performance.week) }}
            </div>
          </div>
          <div class="col-6">
            <div class="stat-box">
              <strong>This Month:</strong>
              {{ colorize(performance.month) }}
            </div>
          </div>
          <div class="col-6">
            <div class="stat-box">
              <strong>Overall:</strong>
              {{ colorize(performance.overall) }}
            </div>
          </div>
          <div class="col-12">
            <div class="stat-box">
              <strong>Daily Avg:</strong>
              <span class="{% if daily_avg > 0 %}text-success{% elif daily_avg < 0 %}text-danger{% else %}text-muted{% endif %}">
                {{ daily_avg }}%
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- System Status, Controls, and Scheduled Tasks Row -->
<div class="row gy-4 mb-4">
  <!-- Token Status -->
  <div class="col-12 col-md-3">
    <div class="card h-100">
      <div class="card-header text-white">System Status</div>
      <div class="card-body small">
        
        <!-- Token Status -->
        <div class="mb-3">
          <strong>Token:</strong><br>
          {% if token_status.valid %}
            <span class="text-success">‚úÖ Valid</span>
          {% else %}
            <span class="text-danger">‚ùå Expired</span>
          {% endif %}
          <ul class="list-unstyled mt-1">
            <li><strong>Issued:</strong> {{ token_status.issued_at }}</li>
            <li><strong>Expires:</strong> {{ token_status.expires_at }}</li>
            {% if token_status.get('refresh_expires_in_days') %}
            <li><strong>Re-auth in:</strong> 
              <span class="{% if token_status.refresh_expires_in_days <= 1.5 %}text-danger{% elif token_status.refresh_expires_in_days <= 3 %}text-warning{% else %}text-success{% endif %}">
                {{ token_status.refresh_expires_in_days }} days
              </span>
            </li>
            {% endif %}
          </ul>
        </div>

        <!-- Authenticated -->
        <div class="mb-3">
          <strong>Authenticated:</strong><br>
          {% if token_status.valid %}
            <span class="text-success">‚úÖ Yes</span>
          {% else %}
            <span class="text-danger">‚ùå No</span>
          {% endif %}
        </div>

        <!-- Scheduler -->
        <div>
          <strong>Scheduler:</strong><br>
          {% if scheduler_running %}
            <span class="text-success">‚úÖ Running</span>
          {% else %}
            <span class="text-warning">‚è∏ Paused</span>
          {% endif %}
        </div>

      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="col-12 col-md-6">
    <div class="card h-100">
      <div class="card-header">Manual Controls</div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-6">
            <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#confirmRunTrades">
              Place Trades
            </button>
          </div>
          <div class="col-6">
            <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#confirmCloseAll">
              Close Positions
            </button>
          </div>
          <div class="col-6">
            <button type="button" class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#confirmToggleScheduler">
              {{ "Pause Scheduler" if scheduler_running else "Resume Scheduler" }}
            </button>
          </div>

          <!-- Re-authentication button when approaching expiry -->
          {% if token_status.get('refresh_warning') or token_status.get('refresh_expires_in_days', 8) <= 2 %}
          <div class="col-12">
            <a href="{{ url_for('authorize') }}" class="btn btn-{{ 'danger' if token_status.get('refresh_expires_in_days', 8) <= 1 else 'warning' }} w-100">
              <i class="fas fa-key"></i> Re-Authenticate ({{ token_status.refresh_expires_in_days|round(1) }} days left)
            </a>
          </div>
          {% elif not token_status.valid %}
          <div class="col-12">
            <a href="{{ url_for('authorize') }}" class="btn btn-warning w-100">
              Re-Authenticate
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Scheduled Tasks -->
  <div class="col-12 col-md-3">
    <div class="card h-100">
      <div class="card-header">Scheduled Tasks</div>
      <div class="card-body">
        {% if scheduled_jobs %}
          <ul class="list-unstyled small">
            {% for job in scheduled_jobs %}
              <li><strong>{{ job.label }}</strong><br>
                  Next: <code>{{ job.next_run }}</code>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-light">No tasks left for today.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Run Morning Trades Modal -->
<div class="modal fade" id="confirmRunTrades" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Trade Execution</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">Are you sure you want to run morning trades?</div>
      <div class="modal-footer">
        <form action="/manual_place_order" method="post">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Yes, Run Trades</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Close All Positions Modal -->
<div class="modal fade" id="confirmCloseAll" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Closing Positions</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">Are you sure you want to close all open positions?</div>
      <div class="modal-footer">
        <form action="/manual_close_positions" method="post">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Yes, Close All</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toggle Scheduler Modal -->
<div class="modal fade" id="confirmToggleScheduler" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Scheduler Toggle</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% if scheduler_running %}
        Pause the scheduler?
        {% else %}
        Resume the scheduler?
        {% endif %}
      </div>
      <div class="modal-footer">
        <form action="/toggle_scheduler" method="post">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">
            {% if scheduler_running %}Pause{% else %}Resume{% endif %}
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  function updateElapsedTime() {
    const el = document.getElementById("last-refresh");
    if (!el || !el.dataset.time) return;

    try {
      const isoTime = el.dataset.time.trim();
      const refreshed = new Date(isoTime);
      if (isNaN(refreshed)) {
        el.textContent = "--";
        return;
      }

      const now = new Date();
      const diffMs = now - refreshed;
      const diffMin = Math.floor(diffMs / 60000);

      el.textContent =
        diffMin === 0 ? "just now" :
        diffMin === 1 ? "1 minute ago" :
        `${diffMin} minutes ago`;
    } catch {
      el.textContent = "--";
    }
  }

  function fetchLastRefresh() {
    fetch("/refresh_timestamp")
      .then(res => res.text())
      .then(text => {
        const el = document.getElementById("last-refresh");
        if (el) {
          el.dataset.time = text.trim();
          updateElapsedTime();
        }
      })
      .catch(() => {
        const el = document.getElementById("last-refresh");
        if (el) el.textContent = "--";
      });
  }

  function refreshRecentLogs() {
    fetch("/recent_logs")
      .then(res => res.text())
      .then(html => {
        const box = document.getElementById("recent-logs-box");
        if (box) {
          box.innerHTML = html;
          // Auto-scroll to bottom
          box.scrollTop = box.scrollHeight;
        }
      });
  }

  // --- Sheet refresh without false timeout alerts ---
  let sheetRefresh = { poll: null, timeout: null, done: false };
  
  function refreshSheet() {
    const refreshBtn = document.getElementById('refresh-sheet-btn');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Refreshing...';
    refreshBtn.disabled = true;
  
    sheetRefresh.done = false;
    if (sheetRefresh.poll) clearInterval(sheetRefresh.poll);
    if (sheetRefresh.timeout) clearTimeout(sheetRefresh.timeout);
  
    fetch('/refresh_sheet', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      cache: 'no-store',
      credentials: 'same-origin'
    })
    .then(r => r.json())
    .then(data => {
      if (data.status === 'started') {
        pollRefreshStatus(refreshBtn, originalText);
      } else {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        showAlert('Error starting refresh: ' + (data.message || 'unknown error'), 'danger');
      }
    })
    .catch(err => {
      refreshBtn.innerHTML = originalText;
      refreshBtn.disabled = false;
      showAlert('Error: ' + err.message, 'danger');
    });
  }
  
  function pollRefreshStatus(refreshBtn, originalText) {
    // Poll every 2s
    sheetRefresh.poll = setInterval(() => {
      fetch('/refresh_sheet_status', { cache: 'no-store', credentials: 'same-origin' })
        .then(r => r.json())
        .then(data => {
          if (data.status === 'success') {
            sheetRefresh.done = true;
            clearInterval(sheetRefresh.poll);
            if (sheetRefresh.timeout) clearTimeout(sheetRefresh.timeout);
  
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
  
            // Update UI now that plan is refreshed
            updateTradePlanDisplay();
            fetchLastRefresh();
            showAlert('Trade plan refreshed successfully!', 'success');
          } else if (data.status === 'error') {
            sheetRefresh.done = true;
            clearInterval(sheetRefresh.poll);
            if (sheetRefresh.timeout) clearTimeout(sheetRefresh.timeout);
  
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
            showAlert('Refresh failed: ' + (data.message || ''), 'danger');
          } else if (data.status === 'in_progress') {
            refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + (data.message || 'Refreshing...');
          } else {
            // unknown / no file ‚Äî keep polling silently
            refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Refreshing...';
          }
        })
        .catch(() => {
          // network blip, keep polling
        });
    }, 2000);
  
    // Soft timeout after 120s: do NOT show a warning if still working
    sheetRefresh.timeout = setTimeout(() => {
      if (sheetRefresh.done) return;
      // Keep polling quietly; downgrade UI text to indicate long run
      refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Still working...';
      // Do not alert the user ‚Äî this prevents the random warning bar
    }, 120000);
  }

  function updateTradePlanDisplay() {
    const buyList = document.getElementById('buy-tickers');
    const shortList = document.getElementById('short-tickers');
    const lastCachedEl = document.getElementById('last-cached');
    if (!buyList || !shortList) return;
  
    fetch('/get_trade_plan', { cache: 'no-store', credentials: 'same-origin' })
      .then(res => res.json())
      .then(data => {
        const buy = (data?.plan?.buy) || [];
        const short = (data?.plan?.short) || [];
  
        // build new HTML off-DOM to avoid flicker
        const buyHTML = buy.map(t => (
          `<span class="badge bg-success fs-5 px-3 py-2 rounded-pill me-2 mb-2">${t}</span>`
        )).join('');
  
        const shortHTML = short.map(t => (
          `<span class="badge bg-danger fs-5 px-3 py-2 rounded-pill me-2 mb-2">${t}</span>`
        )).join('');
  
        // swap in atomically (no clearing first)
        buyList.innerHTML = buyHTML;
        shortList.innerHTML = shortHTML;
  
        if (lastCachedEl && data.last_cached) {
          lastCachedEl.textContent = data.last_cached;
        }
      })
      .catch(err => {
        console.error('updateTradePlanDisplay failed:', err);
        // leave previous content in place on error
      });
  }

  function showAlert(message, type) {
    // Create and show Bootstrap alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at top of main content
    const mainContent = document.querySelector('.container-fluid') || document.body;
    mainContent.insertBefore(alertDiv, mainContent.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
  }

  // Initial call and interval
  fetchLastRefresh();
  refreshRecentLogs();
  setInterval(() => {
    fetchLastRefresh();
    refreshRecentLogs();
    updateElapsedTime();
  }, 60000);

// --- Refresh P/L without page needing two clicks ---
(function () {
  const btn = document.getElementById('refresh-pl-btn');
  const spin = document.getElementById('refresh-pl-spin');
  if (!btn) return;
  let busy = false;

  async function refreshPL() {
    if (busy) return;
    busy = true;
    btn.disabled = true;
    if (spin) spin.classList.remove('d-none');
    try {
      const res = await fetch('/refresh_pl', {
        method: 'POST',
        headers: { 'X-Requested-With': 'fetch' },
        cache: 'no-store',
        credentials: 'same-origin'
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      // We don't need body; the server side has recomputed P/L.
      // Reload once to reflect updated values on the table.
      window.location.reload();
    } catch (err) {
      console.error(err);
      // Fallback: show a simple alert. You can replace with showAlert() if preferred.
      alert('Failed to refresh P/L: ' + err.message);
    } finally {
      if (spin) spin.classList.add('d-none');
      btn.disabled = false;
      busy = false;
    }
  }
  // Ensure single binding
  btn.addEventListener('click', refreshPL, { passive: true });
})();

</script>